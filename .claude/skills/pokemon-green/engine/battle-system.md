# 포켓몬 그린 - 전투 시스템

## 전투 흐름 상태 머신

```
[전투 시작]
     │
     ▼
┌─────────────────────────────┐
│    BATTLE_START             │
│  - 야생 포켓몬 조우 메시지   │
│  - 또는 트레이너 등장 메시지  │
└─────────────────────────────┘
     │
     ▼
┌─────────────────────────────┐
│    SEND_OUT_POKEMON         │◄──────────────────┐
│  - 플레이어 포켓몬 등장      │                   │
│  - 상대 포켓몬 등장          │                   │
└─────────────────────────────┘                   │
     │                                            │
     ▼                                            │
┌─────────────────────────────┐                   │
│    ACTION_SELECTION         │←───┐              │
│  ┌─────────────────────────┐│    │              │
│  │ 1. 싸운다   2. 가방     ││    │              │
│  │ 3. 포켓몬  4. 도망가다  ││    │              │
│  └─────────────────────────┘│    │              │
└─────────────────────────────┘    │              │
     │                             │              │
     ├─[싸운다]──► MOVE_SELECTION  │              │
     │                    │        │              │
     │                    ▼        │              │
     │         ┌──────────────────┐│              │
     │         │TURN_RESOLUTION   ││              │
     │         │- 선공 결정       ││              │
     │         │- 행동 실행       ││              │
     │         │- 데미지 적용     ││              │
     │         └──────────────────┘│              │
     │                    │        │              │
     │                    ▼        │              │
     │         ┌──────────────────┐│              │
     │         │END_TURN_EFFECTS  ││              │
     │         │- 독/화상 데미지   ││              │
     │         │- 상태이상 체크   ││              │
     │         └──────────────────┘│              │
     │                    │        │              │
     │                    ▼        │              │
     │         ┌──────────────────┐│              │
     │         │FAINT_CHECK       ││              │
     │         │- HP 0 체크       ││              │
     │         └──────────────────┘│              │
     │              │    │         │              │
     │   [생존]◄────┘    └──►[기절]│              │
     │      │                 │    │              │
     │      └────────► 다음 턴 ┘   │              │
     │                             │              │
     ├─[가방]──► ITEM_SELECTION ───┘              │
     │                                            │
     ├─[포켓몬]─► POKEMON_SWITCH ─────────────────┘
     │
     └─[도망]───► ESCAPE_ATTEMPT
                         │
        [성공]◄──────────┴──────────►[실패]
           │                            │
           ▼                            │
   ┌──────────────────┐                 │
   │  BATTLE_END      │                 │
   │  - 결과 처리      │                 │
   └──────────────────┘                 │
                                        │
                    ┌───────────────────┘
                    ▼
          [ACTION_SELECTION으로 복귀]
```

---

## 선공 결정 알고리즘

### 우선순위
1. **교체/아이템 사용** > 기술 사용 (교체/아이템은 항상 먼저)
2. **기술 우선도 비교** (우선도가 높은 기술 먼저)
3. **스피드 비교** (스피드가 높은 포켓몬 먼저)
4. **동일 스피드 시 50% 랜덤**

### 기술 우선도
```
+1: 전광석화 (Quick Attack)
 0: 대부분의 기술
-1: 카운터 (Counter)
```

### 스피드 보정
- 마비 상태: 스피드 × 0.25

---

## 턴 진행 순서

### 1. 행동 선택 단계
- 플레이어: 싸운다/가방/포켓몬/도망 선택
- AI: 기술 선택 또는 교체 결정

### 2. 행동 실행 단계 (선공 순서대로)
```
for each 행동 (선공 순서):
    1. 상태이상 행동 가능 체크
       - 잠듦: 행동 불가
       - 얼음: 행동 불가 (10% 해동 체크)
       - 마비: 25% 확률 행동 불가
       - 혼란: 50% 확률 자해

    2. 기술 실행
       - 명중 체크
       - 데미지 계산 (damage-formula.md 참조)
       - 추가 효과 적용

    3. 기절 체크
       - HP 0 시 즉시 기절 처리
       - 경험치 분배
```

### 3. 턴 종료 효과
```
for each 포켓몬:
    - 독: HP × 1/16 데미지
    - 화상: HP × 1/16 데미지
    - 씨뿌리기: HP 흡수
    - 조이기 계열: 연속 데미지
```

### 4. 기절 처리
- 기절한 포켓몬의 소유자가 교체
- 트레이너전: 양측 모두 교체 가능한 포켓몬 없으면 종료
- 야생전: 야생 포켓몬 기절 시 종료

---

## 상태이상 시스템

### 주요 상태이상 (중첩 불가)

| 상태 | 효과 | 지속 |
|------|------|------|
| 독 | 매 턴 최대HP의 1/16 데미지 | 포켓몬센터까지 |
| 화상 | 매 턴 최대HP의 1/16 데미지, 공격력 1/2 | 포켓몬센터까지 |
| 마비 | 스피드 1/4, 25% 확률 행동불가 | 포켓몬센터까지 |
| 얼음 | 행동불가, 10% 확률 해동 | 해동까지 |
| 잠듦 | 1~3턴 행동불가 | 깨어날 때까지 |

### 휘발성 상태 (전투 종료 시 해제)

| 상태 | 효과 | 지속 |
|------|------|------|
| 혼란 | 50% 확률 자해 (40 위력 물리 공격) | 1~4턴 |
| 풀죽음 | 행동 불가 (1턴) | 해당 턴만 |
| 씨뿌리기 | 매 턴 HP 흡수 | 교체까지 |

### 타입 면역
- 독 타입: 독 상태 면역
- 불꽃 타입: 화상 상태 면역
- 전기 타입: 마비 상태 면역
- 얼음 타입: 얼음 상태 면역

---

## 능력치 변화 (랭크 시스템)

### 랭크 범위
-6 ~ 0 ~ +6 (총 13단계)

### 배율
| 랭크 | 배율 |
|------|------|
| +6 | 4.0 |
| +5 | 3.5 |
| +4 | 3.0 |
| +3 | 2.5 |
| +2 | 2.0 |
| +1 | 1.5 |
| 0 | 1.0 |
| -1 | 0.66 |
| -2 | 0.50 |
| -3 | 0.40 |
| -4 | 0.33 |
| -5 | 0.28 |
| -6 | 0.25 |

### 대상 능력치
- 공격
- 방어
- 특수
- 스피드
- 명중률
- 회피율

### 급소 시 무시
급소 히트 시 모든 능력치 변화 무시 (원본 스탯으로 계산)

---

## 도주 시스템

### 야생전 도주
```
도주 확률 = (플레이어 스피드 × 32) / (상대 스피드 / 4) + 30 × 도주 시도 횟수

확률 ≥ 256 이면 확정 도주
```

### 트레이너전
도주 불가능

---

## 경험치 시스템

### 경험치 공식
```
Exp = (b × L × t) / 7

b = 상대 포켓몬 기본 경험치
L = 상대 포켓몬 레벨
t = 트레이너 보정 (야생 1.0, 트레이너 1.5)
```

### 경험치 분배
- 전투에 참가한 포켓몬만 경험치 획득
- 여러 마리가 참가 시 균등 분배

---

## 레벨업

### 조건
현재 경험치 ≥ 다음 레벨 필요 경험치

### 처리
1. 레벨 +1
2. 능력치 재계산
3. 새 기술 습득 체크
4. 진화 조건 체크

### 능력치 계산 (1세대)
```
HP = floor((Base + IV) × 2 + floor(ceil(sqrt(StatExp)) / 4)) × Level / 100 + Level + 10

기타 = floor((Base + IV) × 2 + floor(ceil(sqrt(StatExp)) / 4)) × Level / 100 + 5
```

---

## AI 행동 패턴

### 일반 트레이너
1. 타입 상성 유리한 기술 우선
2. 가장 높은 위력 기술 선택
3. 상태이상 기술 랜덤 사용

### 체육관 관장
1. 상성 불리 시 교체 고려
2. 플레이어 약점 공략
3. 더 전략적인 기술 선택

---

## 특수 기술 처리

### 일격필살 기술
- 뿔드릴, 가위자르기, 땅가르기
- 명중 시 즉사
- 명중률 = (사용자 레벨 - 상대 레벨 + 30)%
- 상대 레벨이 높으면 무조건 실패

### 고정 데미지 기술
- 소닉붐: 고정 20 데미지
- 용의분노: 고정 40 데미지
- 지구던지기/나이트헤드: 사용자 레벨 = 데미지

### 반동 기술
- 이판사판태클, 돌진: 데미지의 1/4 반동
- 자폭, 대폭발: 사용자 기절

### 흡수 기술
- 흡수, 메가드레인: 데미지의 1/2 회복
- 꿈먹기: 자는 상대에게만 사용, 1/2 회복

---

## 전투 종료 조건

### 승리
- 야생전: 야생 포켓몬 기절 또는 포획
- 트레이너전: 상대 모든 포켓몬 기절

### 패배
- 플레이어 모든 포켓몬 기절
- 마지막 포켓몬센터로 이동
- 소지금 절반 잃음

### 도주
- 야생전에서만 가능
- 경험치/아이템 없음
